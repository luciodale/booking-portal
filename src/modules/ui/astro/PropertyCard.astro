---
import type { Asset } from "@/db/schema";
import Badge from "@/modules/ui/astro/Badge.astro";

interface Props {
  asset: Asset;
  imageUrl: string;
  price?: number | null; // null means "no dates selected yet"
  nights?: number;
  appliedRules?: string[];
}

const { asset, imageUrl, price, nights, appliedRules } = Astro.props;

// If price is explicitly null, show placeholder
// If price is undefined, fallback to base price (backward compat)
// If price is a number, use it
const showPlaceholder = price === null;
const displayPrice = price === null ? 0 : (price ?? asset.basePrice / 100);

const isElite = asset.tier === "elite";
const href = isElite ? `/elite/${asset.id}` : `/property/${asset.id}`;
---

<a
  href={href}
  class:list={[
    "group block rounded-2xl overflow-hidden bg-card card-hover",
    { "card-elite": isElite },
  ]}
>
  <!-- Image Container -->
  <div class="relative aspect-4/3 overflow-hidden">
    <img
      src={imageUrl}
      alt={asset.title}
      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
      loading="lazy"
    />

    <!-- Gradient Overlay -->
    <div
      class="absolute inset-0 bg-linear-to-t from-black/60 via-black/20 to-transparent opacity-60 group-hover:opacity-80 transition-opacity duration-300"
    >
    </div>

    <!-- Tier Badge -->
    <div class="absolute top-4 left-4">
      <Badge variant={asset.tier} />
    </div>

    <!-- Favorite Button -->
    <button
      class="absolute top-4 right-4 p-2 rounded-full bg-white/10 backdrop-blur-sm hover:bg-white/20 transition-colors opacity-0 group-hover:opacity-100"
      aria-label="Save to favorites"
    >
      <i data-lucide="heart" class="w-5 h-5 text-white"></i>
    </button>

    <!-- Price Tag -->
    <div class="absolute bottom-4 left-4">
      {
        showPlaceholder ? (
          <div class="text-white">
            <span class="text-lg font-medium text-white/90">
              Select dates for pricing
            </span>
          </div>
        ) : (
          <div class="text-white">
            <span class="text-2xl font-bold">
              {asset.currency === "eur" ? "â‚¬" : asset.currency.toUpperCase()}
              {displayPrice.toLocaleString()}
            </span>
            <span class="text-white/70 text-sm">
              {nights && nights > 1 ? ` / ${nights} nights` : " / night"}
            </span>
            {appliedRules && appliedRules.length > 0 && (
              <div class="flex items-center gap-1 mt-1">
                <i data-lucide="zap" class="w-3 h-3 text-amber-400" />
                <span class="text-xs text-amber-400">{appliedRules[0]}</span>
              </div>
            )}
          </div>
        )
      }
    </div>
  </div>

  <!-- Content -->
  <div class="p-5">
    <h3
      class="text-lg font-semibold text-foreground mb-1 group-hover:text-primary transition-colors duration-200"
    >
      {asset.title}
    </h3>

    <p class="text-muted-foreground text-sm mb-4 flex items-center gap-1">
      <i data-lucide="map-pin" class="w-4 h-4"></i>
      {asset.location}
    </p>

    <!-- Amenities -->
    <div class="flex items-center gap-4 text-muted-foreground text-sm">
      {
        asset.bedrooms && (
          <div class="flex items-center gap-1.5">
            <i data-lucide="bed-double" class="w-4 h-4" />
            {asset.bedrooms} bed{asset.bedrooms !== 1 ? "s" : ""}
          </div>
        )
      }
      {
        asset.bathrooms && (
          <div class="flex items-center gap-1.5">
            <i data-lucide="bath" class="w-4 h-4" />
            {asset.bathrooms} bath{asset.bathrooms !== 1 ? "s" : ""}
          </div>
        )
      }
      {
        asset.maxGuests && (
          <div class="flex items-center gap-1.5">
            <i data-lucide="users" class="w-4 h-4" />
            {asset.maxGuests} guest{asset.maxGuests !== 1 ? "s" : ""}
          </div>
        )
      }
    </div>
  </div>
</a>
