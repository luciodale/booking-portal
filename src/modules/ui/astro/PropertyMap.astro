---
interface Props {
  latitude: string;
  longitude: string;
}

const { latitude, longitude } = Astro.props;
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div
  id="property-map"
  class="w-full md:w-2/3 md:mx-auto aspect-[2/1] rounded-2xl z-0 isolate"
  data-lat={latitude}
  data-lng={longitude}
></div>

<script>
  import L from "leaflet";

  const mapEl = document.getElementById("property-map");
  if (mapEl) {
    const lat = parseFloat(mapEl.dataset.lat ?? "0");
    const lng = parseFloat(mapEl.dataset.lng ?? "0");

    const isMobile = "ontouchstart" in window || navigator.maxTouchPoints > 0;

    const map = L.map(mapEl, {
      scrollWheelZoom: isMobile,
      dragging: isMobile,
      touchZoom: true,
      doubleClickZoom: isMobile,
      attributionControl: false,
      zoomControl: true,
    }).setView([lat, lng], 14);

    function tileUrl(dark: boolean) {
      const variant = dark ? "dark_all" : "light_all";
      return `https://{s}.basemaps.cartocdn.com/${variant}/{z}/{x}/{y}{r}.png`;
    }

    const isDark = document.documentElement.classList.contains("dark");
    let tileLayer = L.tileLayer(tileUrl(isDark), {
      subdomains: "abcd",
      maxZoom: 19,
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);

    // Swap tiles when theme changes
    const observer = new MutationObserver(() => {
      const dark = document.documentElement.classList.contains("dark");
      map.removeLayer(tileLayer);
      tileLayer = L.tileLayer(tileUrl(dark), {
        subdomains: "abcd",
        maxZoom: 19,
      }).addTo(map);
    });
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });
  }
</script>
