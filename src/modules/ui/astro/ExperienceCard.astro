---
import type { LinkedExperience } from "@/features/public/browse/property-detail-queries";
import { localePath } from "@/i18n/locale-path";
import { t } from "@/i18n/t";
import type { Locale } from "@/i18n/types";
import { defaultLocale } from "@/i18n/types";

interface Props {
  experience: LinkedExperience;
  propertyTitle: string;
  ownerWhatsapp: string | null;
  variant?: "standard" | "elite";
  locale?: Locale;
}

const {
  experience: exp,
  propertyTitle,
  ownerWhatsapp,
  variant = "standard",
  locale = (Astro.currentLocale ?? defaultLocale) as Locale,
} = Astro.props;

const isElite = variant === "elite";
const categoryIcon = exp.categoryIcon;

function formatPrice(cents: number, currency: string) {
  const symbol = currency === "eur" ? "\u20AC" : `${currency.toUpperCase()} `;
  return `${symbol}${(cents / 100).toLocaleString()}`;
}
---

<div
  class="group rounded-2xl overflow-hidden bg-card card-hover border border-border"
>
  <div
    class:list={[
      "relative overflow-hidden",
      isElite ? "aspect-16/10" : "aspect-video",
    ]}
  >
    {
      exp.imageUrl ? (
        <img
          src={exp.imageUrl}
          alt={exp.title}
          class:list={[
            "w-full h-full object-cover transition-transform group-hover:scale-110",
            isElite ? "duration-700" : "duration-500",
          ]}
        />
      ) : (
        <div class="w-full h-full bg-linear-to-br from-primary/20 to-primary/5 flex items-center justify-center">
          <i data-lucide="compass" class="w-12 h-12 text-primary/40" />
        </div>
      )
    }

    <div
      class:list={[
        "absolute inset-0",
        isElite
          ? "bg-linear-to-t from-black/70 via-black/20 to-transparent"
          : "bg-linear-to-t from-black/60 via-transparent to-transparent",
      ]}
    >
    </div>

    {
      exp.discountPercent > 0 && (
        <div class="absolute top-4 right-4">
          <span
            class:list={[
              "px-3 rounded-full bg-primary text-primary-foreground text-xs font-bold",
              isElite ? "py-1.5 shadow-lg" : "py-1",
            ]}
          >
            {exp.discountPercent}% {t(locale, "common.off")}
          </span>
        </div>
      )
    }

    {
      isElite ? (
        <div class="absolute bottom-4 left-4 right-4 flex items-center justify-between">
          <span class="badge-elite inline-flex items-center gap-1.5">
            <i data-lucide={categoryIcon} class="w-3.5 h-3.5" />
            {exp.category}
          </span>
          <span class="px-3 py-1 rounded-full bg-white/10 backdrop-blur-sm text-white text-sm">
            {exp.duration}
          </span>
        </div>
      ) : (
        <>
          <div class="absolute top-4 left-4">
            <span class="badge-elite inline-flex items-center gap-1.5">
              <i data-lucide={categoryIcon} class="w-3.5 h-3.5" />
              {exp.category}
            </span>
          </div>
          <div class="absolute bottom-4 right-4">
            <span class="px-3 py-1 rounded-full bg-white/10 backdrop-blur-sm text-white text-sm">
              {exp.duration}
            </span>
          </div>
        </>
      )
    }
  </div>

  <div class:list={[isElite ? "p-6" : "p-5"]}>
    <h3
      class:list={[
        "font-semibold text-foreground",
        isElite ? "text-xl mb-2" : "text-lg mb-1",
      ]}
    >
      {exp.title}
    </h3>
    <p
      class:list={[
        "text-muted-foreground text-sm flex items-center",
        isElite ? "mb-5 gap-2" : "mb-4 gap-1",
      ]}
    >
      <i data-lucide="map-pin" class="w-4 h-4"></i>
      {exp.location}
    </p>
    <div class="flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <div>
          {
            exp.showPrice && (
              <span class="text-sm font-semibold text-foreground">
                {formatPrice(exp.basePrice, exp.currency)}
                {t(locale, "common.perPerson")}
              </span>
            )
          }
          <span class="block text-xs text-muted-foreground"
            >{t(locale, "common.availableAsAddon")}</span
          >
        </div>
        <a
          href={localePath(locale, `/experiences/${exp.id}`)}
          class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg border border-border text-sm font-medium text-foreground hover:bg-secondary transition-colors"
        >
          {t(locale, "common.viewDetails")}
          <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
        </a>
      </div>
      {
        ownerWhatsapp && (
          <a
            href={`https://wa.me/${ownerWhatsapp.replace(/\s+/g, "")}?text=${encodeURIComponent(`Hi! I'm interested in the "${exp.title}" experience at ${propertyTitle}.`)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center gap-2 w-full py-2 rounded-lg bg-[#25D366]/10 text-[#25D366] text-sm font-medium hover:bg-[#25D366]/20 transition-colors"
          >
            <i data-lucide="message-circle" class="w-4 h-4" />
            {t(locale, "common.contactProperty")}
          </a>
        )
      }
    </div>
  </div>
</div>
