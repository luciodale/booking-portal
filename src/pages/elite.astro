---
import { assets, getDb, images } from "@/db";
import PageLayout from "@/layouts/PageLayout.astro";
import { PropertyListWithPricing } from "@/modules/property/ui/PropertyListWithPricing";
import { generateImageUrl } from "@/modules/storage/r2-helpers";
import Button from "@/modules/ui/astro/Button.astro";
import Hero from "@/modules/ui/astro/Hero.astro";
import PropertyCard from "@/modules/ui/astro/PropertyCard.astro";
import { and, desc, eq } from "drizzle-orm";

export const prerender = false;

const db = getDb(Astro.locals.runtime.env.DB);

// Get elite properties and transform to PropertyCard format
const elitePropertiesRaw = await db
  .select()
  .from(assets)
  .where(and(eq(assets.tier, "elite"), eq(assets.status, "published")))
  .orderBy(desc(assets.createdAt));

const eliteProperties = await Promise.all(
  elitePropertiesRaw.map(async (asset) => {
    const [primaryImage] = await db
      .select()
      .from(images)
      .where(and(eq(images.assetId, asset.id), eq(images.isPrimary, true)))
      .limit(1);

    return {
      asset,
      imageUrl: primaryImage ? generateImageUrl(primaryImage.r2Key) : "",
    };
  }),
);

const assetIds = eliteProperties.map((p) => p.asset.id);

const filters = [
  "Beachfront",
  "Mountain",
  "City Center",
  "Pool",
  "5+ Bedrooms",
];
---

<PageLayout
  title="Elite Collection"
  description="Discover our curated selection of the world's most extraordinary luxury properties."
  showMarble
>
  <!-- Hero -->
  <Hero
    badge="Curated Excellence"
    title="Elite Collection"
    titleGradient="Elite"
    subtitle="A handpicked selection of the world's most extraordinary properties. Each residence meets our rigorous standards for luxury, location, and exceptional service."
    height="medium"
  />

  <!-- Date Picker & Filters Bar -->
  <section class="border-b border-border/50 bg-card/50">
    <div class="container mx-auto px-6 py-6">
      <PropertyListWithPricing client:load assetIds={assetIds} />
    </div>
  </section>

  <!-- Filters Bar -->
  <section
    class="sticky top-header-height z-30 glass border-y border-border/50"
  >
    <div class="container mx-auto px-6 py-4">
      <div class="flex flex-wrap items-center gap-4">
        <button class="amenity-chip">
          <i data-lucide="filter" class="w-4 h-4"></i>
          Filters
        </button>
        {
          filters.map((filter) => (
            <button class="amenity-chip">{filter}</button>
          ))
        }

        <div
          class="ml-auto flex items-center gap-3 text-sm text-muted-foreground"
        >
          <span>{eliteProperties.length} properties</span>
          <span class="text-border">|</span>
          <select
            class="bg-transparent border-none text-foreground focus:outline-none"
          >
            <option value="featured">Featured</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Property Grid -->
  <section class="py-16 px-6">
    <div class="container mx-auto">
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        id="property-grid"
      >
        {
          eliteProperties.map((property, index) => (
            <div
              class="animate-slide-up opacity-0 property-card-wrapper"
              style={`animation-delay: ${0.1 + index * 0.1}s`}
              data-asset-id={property.asset.id}
            >
              <PropertyCard {...property} price={null} />
            </div>
          ))
        }
      </div>
    </div>
  </section>

  <script>
    // Listen for price updates and re-render cards with new prices
    window.addEventListener("pricesUpdated", ((event: CustomEvent) => {
      const prices = event.detail.prices;

      // Update each property card with computed price
      document.querySelectorAll(".property-card-wrapper").forEach((wrapper) => {
        const assetId = wrapper.getAttribute("data-asset-id");
        if (!assetId) return;

        const priceData = prices[assetId];
        const priceTag = wrapper.querySelector(".absolute.bottom-4.left-4");

        if (!priceTag) return;

        if (priceData) {
          // Show computed price
          const currency =
            priceData.currency === "eur"
              ? "â‚¬"
              : priceData.currency.toUpperCase();
          const displayPrice = (priceData.computedPrice / 100).toLocaleString();
          const nightsText =
            priceData.nights > 1 ? ` / ${priceData.nights} nights` : " / night";

          let html = `
            <div class="text-white">
              <span class="text-2xl font-bold">${currency} ${displayPrice}</span>
              <span class="text-white/70 text-sm">${nightsText}</span>
          `;

          if (priceData.appliedRules && priceData.appliedRules.length > 0) {
            html += `
              <div class="flex items-center gap-1 mt-1">
                <i data-lucide="zap" class="w-3 h-3 text-amber-400"></i>
                <span class="text-xs text-amber-400">${priceData.appliedRules[0]}</span>
              </div>
            `;
          }

          html += "</div>";
          priceTag.innerHTML = html;

          // Re-initialize lucide icons
          if ((window as any).lucide) {
            (window as any).lucide.createIcons();
          }
        } else {
          // Show placeholder
          priceTag.innerHTML = `
            <div class="text-white">
              <span class="text-lg font-medium text-white/90">Select dates for pricing</span>
            </div>
          `;
        }
      });
    }) as EventListener);
  </script>

  <!-- Load More -->
  <section class="pb-20 px-6 text-center">
    <Button variant="secondary">Load More Properties</Button>
  </section>
</PageLayout>
