---
import { getDb } from "@/db";
import { fetchBookingById } from "@/features/public/bookings/queries";
import { fetchExperiencesByCity } from "@/features/public/browse/experience-queries";
import type { Locale } from "@/i18n/types";
import { defaultLocale } from "@/i18n/types";
import { localePath } from "@/i18n/locale-path";
import { requireAuth } from "@/modules/auth/auth";

export const prerender = false;

const locale = (Astro.currentLocale ?? defaultLocale) as Locale;

let authContext: ReturnType<typeof requireAuth>;
try {
  authContext = requireAuth(Astro.locals);
} catch {
  return Astro.redirect(localePath(locale, "/bookings"));
}

const { id } = Astro.params;
if (!id) return Astro.redirect(localePath(locale, "/bookings"));

const db = getDb(Astro.locals.runtime.env.DB);
const booking = await fetchBookingById(db, id, authContext.userId);
if (!booking) return Astro.redirect(localePath(locale, "/bookings"));

const today = new Date().toISOString().split("T")[0];
const isFuture = booking.checkIn >= today;
// biome-ignore lint/correctness/noUnusedVariables: used in template
const isNew = Astro.url.searchParams.get("new") === "true";

// biome-ignore lint/correctness/noUnusedVariables: used in template
const cityExperiences = isFuture && booking.property.city
  ? (await fetchExperiencesByCity(db, booking.property.city, 1)).experiences
  : [];

// biome-ignore lint/correctness/noUnusedVariables: used in template
const statusColors: Record<string, string> = {
  pending: "bg-yellow-500/10 text-yellow-400 border-yellow-500/20",
  confirmed: "bg-green-500/10 text-green-400 border-green-500/20",
  cancelled: "bg-red-500/10 text-red-400 border-red-500/20",
  completed: "bg-blue-500/10 text-blue-400 border-blue-500/20",
};

// biome-ignore lint/correctness/noUnusedVariables: used in template
const propertyHref = localePath(locale, booking.property.tier === "elite"
  ? `/elite/${booking.property.id}`
  : `/property/${booking.property.id}`);

// biome-ignore lint/correctness/noUnusedVariables: used in template
function formatCents(cents: number, currency: string) {
  return `${(cents / 100).toFixed(2)} ${currency.toUpperCase()}`;
}
---

<PageLayout title={`Booking - ${booking.property.title}`}>
  <section class="py-16 px-6">
    <div class="container mx-auto max-w-2xl space-y-6">

      <!-- Back nav -->
      <a
        href={localePath(locale, "/bookings")}
        class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        {t(locale, "bookings.myBookings")}
      </a>

      <!-- Confirmation banner -->
      {isNew && (
        <div class="flex items-center gap-3 p-4 rounded-xl bg-green-500/10 border border-green-500/20">
          <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center shrink-0">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400">
              <path d="M20 6 9 17l-5-5" />
            </svg>
          </div>
          <p class="text-green-400 text-sm font-medium">{t(locale, "bookings.bookingConfirmedBanner")}</p>
        </div>
      )}

      <!-- Property header card -->
      <a
        href={propertyHref}
        class="flex items-center gap-4 p-4 rounded-xl bg-card border border-border hover:border-primary/30 transition-colors"
      >
        {booking.property.imageUrl && (
          <img
            src={booking.property.imageUrl}
            alt={booking.property.title}
            class="w-20 h-20 rounded-lg object-cover shrink-0"
          />
        )}
        <div class="min-w-0">
          <h1 class="text-lg font-bold text-foreground truncate">{booking.property.title}</h1>
          <p class="text-sm text-muted-foreground flex items-center gap-1 mt-1">
            <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
            {booking.property.location}
          </p>
        </div>
        <i data-lucide="chevron-right" class="w-5 h-5 text-muted-foreground ml-auto shrink-0"></i>
      </a>

      <!-- Status badge -->
      <div>
        <span class={`inline-block px-3 py-1 rounded-full text-xs font-medium border ${statusColors[booking.status] ?? ""}`}>
          {t(locale, `bookings.${booking.status}` as "bookings.pending" | "bookings.confirmed" | "bookings.cancelled" | "bookings.completed")}
        </span>
      </div>

      <!-- Details card -->
      <div class="p-5 rounded-xl bg-card border border-border space-y-3">
        <div class="flex justify-between text-sm">
          <span class="text-muted-foreground">{t(locale, "bookings.checkIn")}</span>
          <span class="text-foreground font-medium">{booking.checkIn}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-muted-foreground">{t(locale, "bookings.checkOut")}</span>
          <span class="text-foreground font-medium">{booking.checkOut}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-muted-foreground">{t(locale, "bookings.nightsLabel")}</span>
          <span class="text-foreground font-medium">{booking.nights}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-muted-foreground">{t(locale, "bookings.guestsLabel")}</span>
          <span class="text-foreground font-medium">{booking.guests}</span>
        </div>

        <div class="border-t border-border my-2"></div>

        <div class="flex justify-between text-sm">
          <span class="text-muted-foreground">{t(locale, "bookings.accommodation")}</span>
          <span class="text-foreground">{formatCents(booking.baseTotal, booking.currency)}</span>
        </div>
        {booking.cleaningFee > 0 && (
          <div class="flex justify-between text-sm">
            <span class="text-muted-foreground">{t(locale, "bookings.cleaningFee")}</span>
            <span class="text-foreground">{formatCents(booking.cleaningFee, booking.currency)}</span>
          </div>
        )}
        {booking.serviceFee > 0 && (
          <div class="flex justify-between text-sm">
            <span class="text-muted-foreground">{t(locale, "bookings.serviceFee")}</span>
            <span class="text-foreground">{formatCents(booking.serviceFee, booking.currency)}</span>
          </div>
        )}

        <div class="border-t border-border my-2"></div>

        <div class="flex justify-between text-sm">
          <span class="text-foreground font-semibold">{t(locale, "bookings.total")}</span>
          <span class="text-foreground font-bold">{formatCents(booking.totalPrice, booking.currency)}</span>
        </div>

        {booking.guestNote && (
          <>
            <div class="border-t border-border my-2"></div>
            <div>
              <span class="text-xs text-muted-foreground uppercase tracking-wide">{t(locale, "bookings.yourNote")}</span>
              <p class="text-sm text-foreground mt-1">{booking.guestNote}</p>
            </div>
          </>
        )}
      </div>

      <!-- Cancellation notice (future only) -->
      {isFuture && (
        <div class="flex items-start gap-3 p-4 rounded-xl bg-card border border-border">
          <i data-lucide="info" class="w-5 h-5 text-muted-foreground shrink-0 mt-0.5"></i>
          <p class="text-sm text-muted-foreground">
            {t(locale, "bookings.cancellationNotice")}
          </p>
        </div>
      )}

      <!-- Experiences section (future only, if city has experiences) -->
      {isFuture && cityExperiences.length > 0 && (
        <div class="pt-4">
          <h2 class="text-xl font-bold text-foreground mb-2">
            {t(locale, "bookings.experiencesIn", { city: booking.property.city! })}
          </h2>
          <p class="text-sm text-muted-foreground mb-6">
            {t(locale, "bookings.enhanceYourStay")}
          </p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            {cityExperiences.map((exp) => (
              <a
                href={localePath(locale, `/experiences/${exp.id}`)}
                class="group block rounded-2xl overflow-hidden bg-card border border-border hover:border-primary/30 transition-colors"
              >
                <div class="relative aspect-[4/3] overflow-hidden">
                  <img
                    src={exp.imageUrl}
                    alt={exp.title}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                  <div class="absolute top-4 left-4">
                    <span class="badge-elite">{exp.category}</span>
                  </div>
                  {exp.duration && (
                    <div class="absolute bottom-4 right-4">
                      <span class="px-3 py-1 rounded-full bg-white/10 backdrop-blur-sm text-white text-sm">
                        {exp.duration}
                      </span>
                    </div>
                  )}
                </div>
                <div class="p-5">
                  <h3 class="text-lg font-semibold text-foreground mb-1 group-hover:text-primary transition-colors">
                    {exp.title}
                  </h3>
                  <p class="text-muted-foreground text-sm flex items-center gap-1">
                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                    {exp.location}
                  </p>
                </div>
              </a>
            ))}
          </div>
          <div class="mt-6 text-center">
            <a
              href={localePath(locale, `/experiences?city=${encodeURIComponent(booking.property.city!)}`)}
              class="text-primary hover:text-primary-hover transition-colors text-sm font-medium inline-flex items-center gap-2"
            >
              {t(locale, "bookings.viewAllExperiences")}
              <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </a>
          </div>
        </div>
      )}

    </div>
  </section>
</PageLayout>
