---
import type { Locale } from "@/i18n/types";
import { defaultLocale } from "@/i18n/types";
import { t } from "@/i18n/t";
import { localePath } from "@/i18n/locale-path";
import { getDb } from "@/db";
import { assets, images } from "@/db/schema";
import PageLayout from "@/layouts/PageLayout.astro";
import { generateImageUrl } from "@/modules/r2/r2-helpers";
import Button from "@/modules/ui/astro/Button.astro";
import Heading from "@/modules/ui/astro/Heading.astro";
import Hero from "@/modules/ui/astro/Hero.astro";
import PropertyCard from "@/modules/ui/astro/PropertyCard.astro";
import { and, desc, eq } from "drizzle-orm";

export const prerender = false;

const locale = (Astro.currentLocale ?? defaultLocale) as Locale;
const db = getDb(Astro.locals.runtime.env.DB);

async function fetchProperties(tier: "elite" | "standard", limit: number) {
  const rows = await db
    .select()
    .from(assets)
    .where(and(eq(assets.status, "published"), eq(assets.tier, tier)))
    .orderBy(desc(assets.createdAt))
    .limit(limit);

  return Promise.all(
    rows.map(async (asset) => {
      const [primaryImage] = await db
        .select()
        .from(images)
        .where(and(eq(images.assetId, asset.id), eq(images.isPrimary, true)))
        .limit(1);

      return {
        asset,
        imageUrl: primaryImage ? generateImageUrl(primaryImage.r2Key) : "",
      };
    })
  );
}

const [eliteProperties, standardProperties] = await Promise.all([
  fetchProperties("elite", 2),
  fetchProperties("standard", 3),
]);
---

<PageLayout title={t(locale, "home.pageTitle")}>
  <Hero
    badge={t(locale, "home.badge")}
    title={t(locale, "home.title")}
    titleGradient={t(locale, "home.titleGradient")}
    subtitle={t(locale, "home.subtitle")}
    backgroundImage="https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=1920&q=80"
  />

  <section class="py-20 px-6">
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-12">
        <div>
          <Heading level={2}>
            <span class="text-gradient">{t(locale, "home.eliteGradient")}</span> {t(locale, "home.eliteHeading", { gradient: "" }).trim()}
          </Heading>
          <p class="text-muted-foreground mt-2">
            {t(locale, "home.eliteDescription")}
          </p>
        </div>
        <a
          href={localePath(locale, "/elite")}
          class="hidden md:flex items-center gap-2 text-primary hover:text-primary-hover transition-colors group"
        >
          {t(locale, "common.viewAll")}
          <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
        </a>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {eliteProperties.map((property) => (
          <PropertyCard {...property} locale={locale} />
        ))}
      </div>
    </div>
  </section>

  <section class="py-20 px-6 bg-card">
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-12">
        <div>
          <Heading level={2}>{t(locale, "home.standardHeading")}</Heading>
          <p class="text-muted-foreground mt-2">
            {t(locale, "home.standardDescription")}
          </p>
        </div>
        <a
          href={localePath(locale, "/standard")}
          class="hidden md:flex items-center gap-2 text-primary hover:text-primary-hover transition-colors group"
        >
          {t(locale, "common.viewAll")}
          <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {standardProperties.map((property) => (
          <PropertyCard {...property} locale={locale} />
        ))}
      </div>
    </div>
  </section>

  <section class="py-24 px-6 relative overflow-hidden">
    <div class="absolute inset-0">
      <div
        class="absolute top-0 left-1/4 w-96 h-96 rounded-full bg-primary/10 blur-[100px]"
      >
      </div>
      <div
        class="absolute bottom-0 right-1/4 w-96 h-96 rounded-full bg-accent/10 blur-[100px]"
      >
      </div>
    </div>

    <div class="container mx-auto relative z-10 text-center">
      <Heading level={2} class="mb-6">
        {t(locale, "home.ctaHeading", { gradient: "" }).trim()} <span class="text-gradient">{t(locale, "home.ctaGradient")}</span>
      </Heading>
      <p class="text-lg text-muted-foreground max-w-xl mx-auto mb-10">
        {t(locale, "home.ctaDescription")}
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <Button href={localePath(locale, "/backoffice")}>{t(locale, "home.becomeHost")}</Button>
        <Button variant="secondary" href={localePath(locale, "/about")}>{t(locale, "home.learnMore")}</Button>
      </div>
    </div>
  </section>
</PageLayout>
