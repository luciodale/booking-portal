---
import { experienceCategoryLabels } from "@/data/helpers";
import { experienceImages, experiences, getDb } from "@/db";
import PageLayout from "@/layouts/PageLayout.astro";
import { generateImageUrl } from "@/modules/r2/r2-helpers";
import Button from "@/modules/ui/astro/Button.astro";
import Heading from "@/modules/ui/astro/Heading.astro";
import Hero from "@/modules/ui/astro/Hero.astro";
import { and, asc, eq } from "drizzle-orm";

export const prerender = false;

const db = getDb(Astro.locals.runtime.env.DB);

const experiencesRaw = await db
  .select()
  .from(experiences)
  .where(eq(experiences.status, "published"))
  .orderBy(asc(experiences.createdAt));

const experiencesWithImages = await Promise.all(
  experiencesRaw.map(async (exp) => {
    const [primaryImg] = await db
      .select()
      .from(experienceImages)
      .where(
        and(
          eq(experienceImages.experienceId, exp.id),
          eq(experienceImages.isPrimary, true)
        )
      )
      .limit(1);

    const imageUrl = primaryImg
      ? generateImageUrl(primaryImg.r2Key)
      : exp.imageUrl ?? "";

    return {
      id: exp.id,
      title: exp.title,
      location: exp.city ?? exp.location,
      imageUrl,
      duration: exp.duration ?? "",
      category: exp.category ? experienceCategoryLabels[exp.category] ?? exp.category : "Other",
    };
  })
);

const categories = ["All", "Sailing", "Food & Wine", "Adventure", "Culture"];
---

<PageLayout
  title="Experiences"
  description="Curated luxury experiences to complement your stay."
  showMarble
>
  <Hero
    badge="Exclusive Access"
    title="Unforgettable Experiences"
    titleGradient="Unforgettable"
    subtitle="Curated luxury experiences crafted by local experts. From private yacht tours to Michelin dining, elevate your journey."
    height="medium"
  />

  <section class="py-8 px-6 border-b border-border">
    <div class="container mx-auto">
      <div class="flex flex-wrap items-center gap-3">
        {categories.map((cat, i) => (
          <button
            class:list={[
              "amenity-chip",
              { "!bg-primary !text-primary-foreground": i === 0 },
            ]}
          >
            {cat}
          </button>
        ))}
      </div>
    </div>
  </section>

  <section class="py-16 px-6">
    <div class="container mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {experiencesWithImages.map((exp, index) => (
          <a
            href={`/experiences/${exp.id}`}
            class="group block rounded-2xl overflow-hidden bg-card card-hover animate-slide-up opacity-0"
            style={`animation-delay: ${0.1 + index * 0.1}s`}
          >
            <div class="relative aspect-[4/3] overflow-hidden">
              <img
                src={exp.imageUrl}
                alt={exp.title}
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
              <div class="absolute top-4 left-4">
                <span class="badge-elite">{exp.category}</span>
              </div>
              <div class="absolute bottom-4 right-4">
                <span class="px-3 py-1 rounded-full bg-white/10 backdrop-blur-sm text-white text-sm">
                  {exp.duration}
                </span>
              </div>
            </div>
            <div class="p-5">
              <h3 class="text-lg font-semibold text-foreground mb-1 group-hover:text-primary transition-colors">
                {exp.title}
              </h3>
              <p class="text-muted-foreground text-sm flex items-center gap-1">
                <i data-lucide="map-pin" class="w-4 h-4"></i>
                {exp.location}
              </p>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <section class="py-20 px-6 bg-card text-center">
    <div class="container mx-auto max-w-2xl">
      <Heading level={2} class="mb-4">
        Have a unique experience to offer?
      </Heading>
      <p class="text-muted-foreground mb-8">
        Partner with EliteStay to reach discerning travelers looking for extraordinary moments.
      </p>
      <Button href="/partner">Become a Partner</Button>
    </div>
  </section>
</PageLayout>
