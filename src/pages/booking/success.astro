---
import { getDb } from "@/db";
import { bookings } from "@/db/schema";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Header from "@/modules/ui/astro/Header.astro";
import { eq } from "drizzle-orm";

export const prerender = false;

const sessionId = Astro.url.searchParams.get("session_id");

if (sessionId) {
  const D1Database = Astro.locals.runtime?.env?.DB;
  if (D1Database) {
    const db = getDb(D1Database);
    const [found] = await db
      .select({ id: bookings.id })
      .from(bookings)
      .where(eq(bookings.stripeSessionId, sessionId))
      .limit(1);

    if (found) {
      return Astro.redirect(`/bookings/${found.id}?new=true`);
    }
  }
}
---

<BaseLayout title="Booking Confirmed">
  <Header />
  <main class="min-h-content-fit flex items-center justify-center px-6 py-16">
    <div class="w-full max-w-md">
      <div class="p-8 rounded-2xl bg-card border border-border text-center space-y-4">
        <h1 class="text-xl font-bold text-foreground">Booking Not Found</h1>
        <p class="text-muted-foreground text-sm">
          We couldn't find a booking for this session. If you just completed payment, it may take a moment to process.
        </p>
        <a
          href="/bookings"
          class="inline-block py-2 px-6 rounded-xl bg-primary text-primary-foreground text-sm font-semibold hover:bg-primary/90 transition-colors"
        >
          View My Bookings
        </a>
      </div>
    </div>
  </main>
</BaseLayout>
