---
import { getDb } from "@/db";
import { getExperienceCategoryIcon } from "@/features/broker/experience/constants/categoryLabels";
import { ExperienceBookingWidget } from "@/features/public/booking/ui/ExperienceBookingWidget";
import { fetchExperienceById } from "@/features/public/browse/experience-queries";
import { localePath } from "@/i18n/locale-path";
import { t } from "@/i18n/t";
import type { Locale } from "@/i18n/types";
import { defaultLocale } from "@/i18n/types";
import PageLayout from "@/layouts/PageLayout.astro";
import { generateImageUrl } from "@/modules/r2/r2-helpers";
import ImageGallery from "@/modules/ui/astro/ImageGallery.astro";
import PropertyCard from "@/modules/ui/astro/PropertyCard.astro";
import { formatLocation } from "@/utils/formatLocation";

export const prerender = false;

const locale = (Astro.currentLocale ?? defaultLocale) as Locale;

const { id } = Astro.params;
if (!id) return Astro.redirect(localePath(locale, "/experiences"));

const db = getDb(Astro.locals.runtime.env.DB);
const data = await fetchExperienceById(db, id);

if (!data) return Astro.redirect(localePath(locale, "/experiences"));

const { experience, imageUrls, categoryLabel, linkedProperties } = data;

const primaryImageUrl =
  imageUrls[0] ??
  (experience.imageUrl ? generateImageUrl(experience.imageUrl) : "");
const categoryIcon = getExperienceCategoryIcon(experience.category ?? "other");

function formatPrice(cents: number, currency: string) {
  const symbol = currency === "eur" ? "\u20AC" : `${currency.toUpperCase()} `;
  return `${symbol}${(cents / 100).toLocaleString()}`;
}
---

<PageLayout
  title={`${experience.title} | Experiences`}
  description={experience.shortDescription ??
    experience.description?.substring(0, 160) ??
    ""}
>
  <!-- Hero -->
  <section
    class="relative h-[50vh] min-h-[400px] flex items-end overflow-hidden"
  >
    {
      primaryImageUrl && (
        <img
          src={primaryImageUrl}
          alt={experience.title}
          class="absolute inset-0 w-full h-full object-cover"
        />
      )
    }
    <div
      class="absolute inset-0 bg-linear-to-t from-black/80 via-black/40 to-transparent"
    >
    </div>

    <div class="relative z-10 container mx-auto px-6 pb-12">
      <a
        href={localePath(locale, "/experiences")}
        class="inline-flex items-center gap-2 text-white/70 hover:text-white transition-colors mb-6"
      >
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        {t(locale, "experiences.backToExperiences")}
      </a>

      <div class="mb-4">
        <span class="badge-elite">{categoryLabel}</span>
      </div>

      <h1 class="text-4xl md:text-5xl font-bold text-white mb-3">
        {experience.title}
      </h1>

      <p class="text-white/80 flex items-center gap-2 text-lg">
        <i data-lucide="map-pin" class="w-5 h-5"></i>
        {formatLocation(experience)}
      </p>
    </div>
  </section>

  <!-- Quick Stats Bar -->
  <section
    class="sticky top-header-height z-30 h-subheader-height bg-card/95 backdrop-blur-sm border-b border-border"
  >
    <div class="container mx-auto px-6 h-full flex items-center">
      <div class="flex flex-wrap items-center gap-6 text-sm">
        {
          experience.duration && (
            <div class="flex items-center gap-2 text-foreground">
              <i data-lucide="clock" class="w-4 h-4 text-primary" />
              {experience.duration}
            </div>
          )
        }
        {
          experience.maxParticipants && (
            <div class="flex items-center gap-2 text-foreground">
              <i data-lucide="users" class="w-4 h-4 text-primary" />
              {t(locale, "experiences.upToParticipants", {
                count: experience.maxParticipants,
              })}
            </div>
          )
        }
        {
          experience.showPrice && (
            <div class="flex items-center gap-2 text-foreground">
              <i data-lucide="tag" class="w-4 h-4 text-primary" />
              {formatPrice(experience.basePrice, experience.currency)}{" "}
              {t(locale, "experiences.perPerson")}
            </div>
          )
        }
        <div class="flex items-center gap-2 text-foreground">
          <i data-lucide={categoryIcon} class="w-4 h-4 text-primary"></i>
          {categoryLabel}
        </div>
      </div>
    </div>
  </section>

  <!-- Image Gallery -->
  {
    imageUrls.length > 1 && (
      <section class="py-10 px-6">
        <div class="container mx-auto">
          <ImageGallery
            images={imageUrls}
            title={experience.title}
            variant="standard"
          />
        </div>
      </section>
    )
  }

  <!-- Mobile booking widget (below images) -->
  <section class="lg:hidden px-6 pb-8">
    <div class="container mx-auto">
      <ExperienceBookingWidget
        client:only="react"
        experienceId={experience.id}
        basePrice={experience.basePrice}
        currency={experience.currency}
        maxParticipants={experience.maxParticipants ?? 10}
        instantBook={experience.instantBook}
        additionalCosts={experience.additionalCosts ?? null}
      />
    </div>
  </section>

  <section class="py-12 px-6">
    <div class="container mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
        <!-- Main content (2/3) -->
        <div class="lg:col-span-2">
          <h2 class="text-2xl font-bold text-foreground mb-6">
            {t(locale, "experiences.aboutThisExperience")}
          </h2>
          <div class="prose prose-invert max-w-none">
            {
              (experience.description ?? "")
                .split("\n\n")
                .map((paragraph) => (
                  <p class="text-muted-foreground leading-relaxed mb-4">
                    {paragraph}
                  </p>
                ))
            }
          </div>
        </div>

        <!-- Sidebar (1/3) â€” desktop only -->
        <div class="hidden lg:block lg:col-span-1">
          <div class="sticky top-sticky-offset z-20">
            <ExperienceBookingWidget
              client:only="react"
              experienceId={experience.id}
              basePrice={experience.basePrice}
              currency={experience.currency}
              maxParticipants={experience.maxParticipants ?? 10}
              instantBook={experience.instantBook}
              additionalCosts={experience.additionalCosts ?? null}
            />
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Linked Properties -->
  {
    linkedProperties.length > 0 && (
      <section class="py-16 px-6 bg-card/50">
        <div class="container mx-auto">
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-foreground mb-2">
              {t(locale, "experiences.availableAtProperties")}
            </h2>
            <p class="text-muted-foreground">
              {t(locale, "experiences.bookAndAdd")}
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {linkedProperties.map((property, index) => (
              <div
                class="animate-slide-up opacity-0"
                style={`animation-delay: ${0.1 + index * 0.1}s`}
              >
                <PropertyCard {...property} target="_blank" locale={locale} />
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }
</PageLayout>
